@page
@model soft20181_starter.Pages.Admin.AuditLogsModel
@{
    ViewData["Title"] = "Audit Logs";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-history"></i> Audit Logs
                    </h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Filter Form -->
                    <form method="get" class="mb-4">
                        <div class="row">
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label asp-for="EntityName">Entity Type</label>
                                    <select asp-for="EntityName" class="form-control">
                                        <option value="">All Entities</option>
                                        <option value="TheEvent">Events</option>
                                        <option value="AppUser">Users</option>
                                        <option value="Contact">Contacts</option>
                                        <option value="Feedback">Feedback</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label asp-for="Action">Action</label>
                                    <select asp-for="Action" class="form-control">
                                        <option value="">All Actions</option>
                                        <option value="Create">Create</option>
                                        <option value="Update">Update</option>
                                        <option value="Delete">Delete</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label asp-for="UserId">User ID</label>
                                    <input asp-for="UserId" class="form-control" placeholder="Enter User ID" />
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label asp-for="FromDate">From Date</label>
                                    <input asp-for="FromDate" type="date" class="form-control" />
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label asp-for="ToDate">To Date</label>
                                    <input asp-for="ToDate" type="date" class="form-control" />
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-search"></i> Filter
                                        </button>
                                        <a asp-page="./AuditLogs" class="btn btn-secondary">
                                            <i class="fas fa-times"></i> Clear
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- Audit Logs Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Entity</th>
                                    <th>Action</th>
                                    <th>User</th>
                                    <th>Changes</th>
                                    <th>IP Address</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var log in Model.AuditLogs)
                                {
                                    <tr>
                                        <td>
                                            <small class="text-muted">
                                                @log.GetFormattedTimestamp()
                                            </small>
                                        </td>
                                        <td>
                                            <span class="badge badge-info">@log.EntityName</span>
                                            <br />
                                            <small class="text-muted">ID: @log.EntityId</small>
                                        </td>
                                        <td>
                                            @{
                                                var actionClass = log.Action switch
                                                {
                                                    "Create" => "badge-success",
                                                    "Update" => "badge-warning",
                                                    "Delete" => "badge-danger",
                                                    _ => "badge-secondary"
                                                };
                                            }
                                            <span class="badge @actionClass">@log.Action</span>
                                        </td>
                                        <td>
                                            <strong>@log.UserName</strong>
                                            <br />
                                            <small class="text-muted">@log.UserRole</small>
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(log.Changes))
                                            {
                                                <span class="text-truncate d-inline-block" style="max-width: 200px;" title="@log.Changes">
                                                    @log.Changes
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">No changes recorded</span>
                                            }
                                        </td>
                                        <td>
                                            <small class="text-muted">@log.IpAddress</small>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-outline-info" 
                                                    data-toggle="modal" data-target="#auditDetailModal" 
                                                    data-log-id="@log.Id">
                                                <i class="fas fa-eye"></i> View
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    @if (Model.TotalPages > 1)
                    {
                        <nav aria-label="Audit logs pagination">
                            <ul class="pagination justify-content-center">
                                @if (Model.CurrentPage > 1)
                                {
                                    <li class="page-item">
                                        <a class="page-link" asp-page="./AuditLogs" asp-route-page="@(Model.CurrentPage - 1)" 
                                           asp-route-entityName="@Model.EntityName" asp-route-action="@Model.Action" 
                                           asp-route-userId="@Model.UserId" asp-route-fromDate="@Model.FromDate?.ToString("yyyy-MM-dd")" 
                                           asp-route-toDate="@Model.ToDate?.ToString("yyyy-MM-dd")">
                                            Previous
                                        </a>
                                    </li>
                                }

                                @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                                {
                                    <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                        <a class="page-link" asp-page="./AuditLogs" asp-route-page="@i" 
                                           asp-route-entityName="@Model.EntityName" asp-route-action="@Model.Action" 
                                           asp-route-userId="@Model.UserId" asp-route-fromDate="@Model.FromDate?.ToString("yyyy-MM-dd")" 
                                           asp-route-toDate="@Model.ToDate?.ToString("yyyy-MM-dd")">
                                            @i
                                        </a>
                                    </li>
                                }

                                @if (Model.CurrentPage < Model.TotalPages)
                                {
                                    <li class="page-item">
                                        <a class="page-link" asp-page="./AuditLogs" asp-route-page="@(Model.CurrentPage + 1)" 
                                           asp-route-entityName="@Model.EntityName" asp-route-action="@Model.Action" 
                                           asp-route-userId="@Model.UserId" asp-route-fromDate="@Model.FromDate?.ToString("yyyy-MM-dd")" 
                                           asp-route-toDate="@Model.ToDate?.ToString("yyyy-MM-dd")">
                                            Next
                                        </a>
                                    </li>
                                }
                            </ul>
                        </nav>
                    }

                    <!-- Summary -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <p class="text-muted">
                                Showing @((Model.CurrentPage - 1) * Model.PageSize + 1) to @Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalCount) 
                                of @Model.TotalCount audit logs
                            </p>
                        </div>
                        <div class="col-md-6 text-right">
                            <a href="@Url.Page("./AuditLogs", new { export = "csv" })" class="btn btn-success">
                                <i class="fas fa-download"></i> Export CSV
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Audit Detail Modal -->
<div class="modal fade" id="auditDetailModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Audit Log Details</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="auditDetailContent">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Handle audit detail modal
            $('#auditDetailModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var logId = button.data('log-id');
                var modal = $(this);
                
                // Load audit log details via AJAX
                $.get('/Admin/AuditLogs/Details/' + logId, function(data) {
                    modal.find('#auditDetailContent').html(data);
                });
            });
        });
    </script>
}
